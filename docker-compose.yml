services:
  navidrome:
    image: deluan/navidrome:latest
    ports:
      - "4533:4533"
    environment:
      # Existing settings...
      ND_SCANSCHEDULE: "@every 1h"
      ND_LOGLEVEL: info
      
      # --- NEW PERFORMANCE SETTINGS ---
      # Cache images in memory so scrolling is instant
      ND_IMAGECACHESIZE: "100MB"
      
      # Keep transcoded songs for a long time (prevents re-doing work)
      ND_TRANSCODINGCACHESIZE: "2GB"
      
      # Use all CPU cores for transcoding (faster startup)
      ND_TRANSCODINGPARALLELISM: 0
    volumes:
      - "./data/navidrome:/data"
      - "./music:/music"
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:4533/ping"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  syncthing:
    image: syncthing/syncthing
    hostname: aws-music-server
    environment:
      - PUID=${UID:-1000}
      - PGID=${GID:-1000}
    volumes:
      - "./data/syncthing:/var/syncthing/config"
      - "./music:/var/syncthing/Music"
    ports:
      - "8384:8384"
      - "22000:22000/tcp"
      - "22000:22000/udp"
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8384/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  caddy:
    image: caddy:latest
    depends_on:
      - navidrome
    environment:
      - DOMAIN=${DOMAIN:-your-domain.duckdns.org}
    ports:
      - "80:80"
      - "443:443"
      - "8443:8443"
    extra_hosts:
      - "host.docker.internal:host-gateway"
    volumes:
      - ./Caddyfile:/etc/caddy/Caddyfile:ro
      - caddy_data:/data
      - caddy_config:/config
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:2019/config/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

# This section below is what was missing
volumes:
  caddy_data:
  caddy_config:
